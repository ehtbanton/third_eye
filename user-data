#cloud-config
# Third Eye - Ultra Simple: Just WiFi + mDNS

hostname: thirdeye

users:
  - name: anton
    groups: users,adm,dialout,audio,video,plugdev,netdev,gpio,i2c,spi
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    lock_passwd: false
    passwd: $6$rounds=4096$saltsalt$YhBVRoeDvUJEjxcKuQCwbUUnNzCdULNiLpXPaFpq9tqxPnHcHlCkWg3IUqPPQakQ4s.rXgH6mGFQFSmw.jPMC0

ssh_pwauth: true

runcmd:
  - |
    exec > /boot/firmware/setup.log 2>&1
    echo "=== Third Eye Setup: $(date) ==="

    # Install packages
    echo "[1/3] Installing packages..."
    apt-get update -qq
    apt-get install -y python3-picamera2 python3-flask avahi-daemon network-manager

    # Connect to Antonet
    echo "[2/3] Connecting to Antonet..."
    nmcli dev wifi connect Antonet password 5maltesers
    sleep 10

    IP=$(hostname -I | awk '{print $1}')
    echo "Connected! IP: $IP"

    # Create camera server
    echo "[3/3] Setting up cameras..."
    cat > /home/anton/cameras.py << 'EOF'
#!/usr/bin/env python3
import io, time, threading, logging
from flask import Flask, Response
from picamera2 import Picamera2
from PIL import Image

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class Camera:
    def __init__(self, idx):
        self.frame, self.lock = None, threading.Lock()
        try:
            self.cam = Picamera2(idx)
            cfg = self.cam.create_still_configuration(main={"size": (1920, 1080), "format": "RGB888"})
            self.cam.configure(cfg)
            self.cam.start()
            logger.info(f"Camera {idx} ready")
        except Exception as e:
            self.cam = None
            logger.error(f"Camera {idx} failed: {e}")

    def loop(self):
        while self.cam:
            try:
                arr = self.cam.capture_array()
                buf = io.BytesIO()
                Image.fromarray(arr).save(buf, format='JPEG', quality=85)
                with self.lock:
                    self.frame = buf.getvalue()
                time.sleep(0.03)  # ~30fps
            except:
                time.sleep(0.1)

    def get_frame(self):
        with self.lock:
            return self.frame

# Start cameras
cams = [Camera(i) for i in range(3)]
for c in cams:
    threading.Thread(target=c.loop, daemon=True).start()

# Create Flask apps
def make_app(port, cam):
    app = Flask(f"cam{port}")

    @app.route('/stream')
    def stream():
        def gen():
            while True:
                f = cam.get_frame()
                if f:
                    yield b'--frame\r\nContent-Type: image/jpeg\r\n\r\n' + f + b'\r\n'
                time.sleep(0.03)
        return Response(gen(), mimetype='multipart/x-mixed-replace; boundary=frame')

    @app.route('/health')
    def health():
        return 'OK' if cam.cam else 'FAIL', 200 if cam.cam else 503

    return app

if __name__ == '__main__':
    for i, cam in enumerate(cams):
        port = 8081 + i
        threading.Thread(target=lambda p=port, c=cam: make_app(p, c).run(host='0.0.0.0', port=p), daemon=True).start()
    logger.info("Cameras ready at :8081, :8082, :8083")
    while True:
        time.sleep(1)
EOF

    chown anton:anton /home/anton/cameras.py
    chmod +x /home/anton/cameras.py

    # Create systemd service
    cat > /etc/systemd/system/cameras.service << 'EOF'
[Unit]
Description=Third Eye Cameras
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=anton
ExecStart=/usr/bin/python3 /home/anton/cameras.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    # Enable mDNS
    systemctl enable avahi-daemon
    systemctl start avahi-daemon

    # Start cameras
    systemctl daemon-reload
    systemctl enable cameras
    systemctl start cameras

    echo "=== DONE! Access at http://thirdeye.local:8081/stream ==="
    echo "IP: $IP"
